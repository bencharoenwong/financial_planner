<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Goal Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        .status-green { background-color: #10b981; }
        .status-yellow { background-color: #f59e0b; }
        .status-red { background-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">üí∞ Financial Goal Analyzer</h1>
            <p class="text-gray-400">Determine if your wealth accumulation goal is realistic</p>

            <!-- Mode Toggle -->
            <div class="mt-4 inline-flex rounded-lg bg-gray-800 p-1">
                <button type="button" id="goalModeBtn" onclick="setCalculatorMode('goal')"
                    class="px-4 py-2 text-sm font-medium rounded-md bg-blue-600 text-white transition">
                    Goal Mode
                </button>
                <button type="button" id="fireModeBtn" onclick="setCalculatorMode('fire')"
                    class="px-4 py-2 text-sm font-medium rounded-md text-gray-400 hover:text-white transition">
                    üî• FIRE Mode
                </button>
            </div>
            <div class="mt-2">
                <button type="button" onclick="showHelp('glossary')" class="text-xs text-gray-500 hover:text-gray-300">
                    üìñ Financial Terms Glossary
                </button>
            </div>
        </div>

        <!-- Calculator Form -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8 shadow-xl">
            <form id="calculatorForm" class="space-y-6">
                <!-- Goal Mode Inputs -->
                <div id="goalModeInputs" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Current Wealth -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Current Savings ($)
                            <button type="button" onclick="showHelp('currentSavings')" class="ml-1 text-gray-500 hover:text-gray-300">‚ìò</button>
                        </label>
                        <input type="number" id="currentWealth" value="10000" min="1" required
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <div class="text-xs text-gray-500 mt-1">Total investable assets today (401k, IRA, brokerage, etc.)</div>
                    </div>

                    <!-- Target Wealth -->
                    <div id="targetWealthSection">
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            What's your goal amount?
                            <button type="button" onclick="showHelp('targetGoal')" class="ml-1 text-gray-500 hover:text-gray-300">‚ìò</button>
                        </label>
                        <input type="number" id="targetWealth" value="1000000" min="1" required
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            onchange="updateInflationAdjustedTarget()">

                        <!-- Simplified toggle with plain language -->
                        <div class="mt-2 flex items-center gap-2">
                            <span class="text-xs text-gray-400">I'm thinking in:</span>
                            <div class="inline-flex rounded bg-gray-700 p-0.5">
                                <button type="button" id="todayDollarsBtn" onclick="setTargetType('today')"
                                    class="px-2 py-1 text-xs rounded bg-blue-600 text-white cursor-pointer transition-colors hover:bg-blue-500">
                                    Today's buying power
                                </button>
                                <button type="button" id="futureDollarsBtn" onclick="setTargetType('future')"
                                    class="px-2 py-1 text-xs rounded text-gray-400 cursor-pointer transition-colors hover:text-gray-200 hover:bg-gray-600">
                                    Actual future amount
                                </button>
                            </div>
                            <button type="button" onclick="showHelp('realVsNominal')" class="text-xs text-blue-400 hover:text-blue-300">?</button>
                        </div>

                        <!-- Hidden select for form submission -->
                        <select id="targetValueType" class="hidden" onchange="updateInflationAdjustedTarget()">
                            <option value="future">Future dollars (nominal)</option>
                            <option value="today" selected>Today's dollars (real)</option>
                        </select>

                        <!-- Clear explanation based on selection -->
                        <div id="targetExplanation" class="mt-2 p-3 rounded text-sm">
                            <div id="todayDollarsExplanation">
                                <div class="text-gray-300">
                                    <strong class="text-white">You want: $<span id="targetInTodayTerms">1,000,000</span></strong> in today's buying power
                                </div>
                                <div class="mt-2 flex items-center gap-2 text-xs">
                                    <span class="text-gray-400">With</span>
                                    <input type="number" id="goalInflationInline" value="3" min="1" max="6" step="0.5"
                                        class="w-14 bg-gray-600 border-none rounded px-2 py-1 text-white text-center"
                                        onchange="updateInflationAdjustedTarget()">
                                    <span class="text-gray-400">% inflation over</span>
                                    <span id="yearsDisplay" class="text-white">30</span>
                                    <span class="text-gray-400">years...</span>
                                </div>
                                <div class="mt-2 bg-yellow-900/40 border border-yellow-700/50 rounded p-2">
                                    <div class="text-yellow-300 text-xs">You'll actually need:</div>
                                    <div class="text-yellow-100 font-bold text-xl" id="nominalTargetDisplay">$2,427,000</div>
                                    <div class="text-yellow-400/70 text-xs">in your account to have that buying power</div>
                                </div>
                            </div>
                            <div id="futureDollarsExplanation" class="hidden">
                                <div class="text-gray-300">
                                    <strong class="text-white">You'll have: $<span id="targetInFutureTerms">1,000,000</span></strong> in your account
                                </div>
                                <div class="mt-2 bg-gray-700/50 rounded p-2 text-xs">
                                    <span class="text-gray-400">Worth approximately </span>
                                    <span class="text-white font-medium" id="realValueDisplay">$412,000</span>
                                    <span class="text-gray-400"> in today's buying power</span>
                                    <div class="text-gray-500 mt-1">(assuming 3% inflation over 30 years)</div>
                                </div>
                            </div>
                        </div>
                        <div id="targetValueHelp" class="hidden"></div>
                    </div>

                    <!-- Inflation Rate (Goal Mode) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Expected Inflation
                            <button type="button" onclick="showHelp('inflation')" class="ml-1 text-gray-500 hover:text-gray-300">‚ìò</button>
                        </label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="goalInflation" min="1" max="5" step="0.5" value="3"
                                class="flex-1 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer"
                                oninput="document.getElementById('goalInflationDisplay').textContent = this.value + '%'; updateInflationAdjustedTarget()">
                            <span id="goalInflationDisplay" class="text-sm font-medium text-white w-12 text-right">3%</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">Historical US average: ~3%</div>
                    </div>

                    <!-- Years (Goal Mode) -->
                    <div id="yearsSection">
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Years Until Goal
                            <button type="button" onclick="showHelp('yearsToGoal')" class="ml-1 text-gray-500 hover:text-gray-300">‚ìò</button>
                        </label>
                        <input type="number" id="yearsToGoal" value="30" min="1" max="50" required
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            onchange="updateInflationAdjustedTarget()">
                        <div class="text-xs text-gray-500 mt-1">Time until you need to access this money</div>
                    </div>

                    <!-- Years in Retirement (NEW) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Years in Retirement
                            <button type="button" onclick="showHelp('retirementYears')" class="ml-1 text-gray-500 hover:text-gray-300">‚ìò</button>
                        </label>
                        <input type="number" id="retirementYears" value="30" min="10" max="50"
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <div class="text-xs text-gray-500 mt-1">How long your money needs to last after retiring</div>
                    </div>
                </div>

                <!-- FIRE Mode Inputs (hidden by default) -->
                <div id="fireModeInputs" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Current Savings (FIRE) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Current Portfolio ($)
                            <button type="button" onclick="showHelp('currentSavings')" class="ml-1 text-gray-500 hover:text-gray-300">‚ìò</button>
                        </label>
                        <input type="number" id="fireCurrentWealth" value="50000" min="0"
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        <div class="text-xs text-gray-500 mt-1">All invested assets (retirement accounts + taxable)</div>
                    </div>

                    <!-- Monthly Expenses -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Monthly Expenses in Retirement ($)
                            <button type="button" onclick="showHelp('monthlyExpenses')" class="ml-1 text-gray-500 hover:text-gray-300">‚ìò</button>
                        </label>
                        <input type="number" id="fireMonthlyExpenses" value="4000" min="1"
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                            onchange="updateFireNumber()">
                        <div class="text-xs text-gray-500 mt-1">
                            In <strong>today's dollars</strong>. Annual: $<span id="fireAnnualExpenses">48,000</span>
                        </div>
                    </div>

                    <!-- Current Age -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Current Age
                        </label>
                        <input type="number" id="fireCurrentAge" value="30" min="18" max="80"
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        <div class="text-xs text-gray-500 mt-1">Your age today</div>
                    </div>

                    <!-- Expected Retirement Duration -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Years in Retirement
                            <button type="button" onclick="showHelp('retirementDuration')" class="ml-1 text-gray-500 hover:text-gray-300">‚ìò</button>
                        </label>
                        <input type="number" id="fireRetirementYears" value="30" min="10" max="60"
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                            onchange="adjustSWRForDuration()">
                        <div class="text-xs text-gray-500 mt-1">How long your money needs to last</div>
                        <div id="swrRecommendation" class="text-xs text-yellow-400 mt-1 hidden"></div>
                    </div>

                    <!-- Monthly Investment -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Monthly Investment ($)
                            <button type="button" onclick="showHelp('monthlyInvestment')" class="ml-1 text-gray-500 hover:text-gray-300">‚ìò</button>
                        </label>
                        <input type="number" id="fireMonthlyInvestment" value="1500" min="0"
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        <div class="text-xs text-gray-500 mt-1">Amount you invest each month (after expenses)</div>
                    </div>

                    <!-- Safe Withdrawal Rate -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Safe Withdrawal Rate (SWR)
                            <button type="button" onclick="showHelp('swr')" class="ml-1 text-gray-500 hover:text-gray-300">‚ìò</button>
                        </label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="fireSWR" min="2.5" max="5" step="0.25" value="4"
                                class="flex-1 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer"
                                oninput="updateFireNumber()">
                            <span id="fireSWRDisplay" class="text-sm font-medium text-white w-12 text-right">4%</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">% of portfolio you withdraw annually. Lower = safer but requires more savings.</div>
                    </div>

                    <!-- Inflation Rate -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Expected Inflation
                            <button type="button" onclick="showHelp('inflation')" class="ml-1 text-gray-500 hover:text-gray-300">‚ìò</button>
                        </label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="fireInflation" min="1" max="5" step="0.5" value="3"
                                class="flex-1 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer"
                                oninput="document.getElementById('fireInflationDisplay').textContent = this.value + '%'">
                            <span id="fireInflationDisplay" class="text-sm font-medium text-white w-12 text-right">3%</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">Historical US average: ~3%. Reduces your real returns.</div>
                    </div>

                    <!-- Monthly Contribution / Savings Rate Toggle -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-sm font-medium text-gray-300">Monthly Savings</label>
                            <button type="button" onclick="toggleSavingsMode()" class="text-xs text-blue-400 hover:text-blue-300">
                                <span id="savingsModeToggle">Switch to salary + rate ‚Üí</span>
                            </button>
                        </div>

                        <!-- Direct contribution input (default) -->
                        <div id="directContributionMode" class="space-y-3">
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Regular monthly savings</label>
                                <input type="number" id="monthlyContributionBase" value="500" min="0" required
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Monthly savings ($)" onchange="updateDirectContribution()">
                            </div>
                            <div class="pt-2 border-t border-gray-600">
                                <label class="text-xs text-gray-400 mb-1 block">
                                    + Additional top-up (bonuses, windfalls, annual bonus √∑ 12, etc.)
                                </label>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500 text-sm">$</span>
                                    <input type="number" id="monthlyTopUp" value="0" min="0"
                                        class="flex-1 bg-gray-600 border-none rounded px-3 py-2 text-white text-sm focus:ring-2 focus:ring-blue-500"
                                        placeholder="0" onchange="updateDirectContribution()">
                                    <span class="text-gray-500 text-sm">/mo</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between text-sm font-medium pt-2 border-t border-gray-600">
                                <span class="text-gray-300">Total monthly savings:</span>
                                <span id="directTotalSavings" class="text-green-400">$500/mo</span>
                            </div>
                            <!-- Hidden field that gets submitted -->
                            <input type="hidden" id="monthlyContribution" value="500">
                        </div>

                        <!-- Salary + rate mode (hidden by default) -->
                        <div id="salaryRateMode" class="hidden space-y-3">
                            <div>
                                <input type="number" id="netMonthlySalary" value="6000" min="0"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Net monthly salary ($)" onchange="updateCalculatedContribution()">
                            </div>
                            <div class="flex items-center gap-3">
                                <input type="range" id="savingsRateSlider" min="0" max="50" value="15"
                                    class="flex-1 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer"
                                    oninput="updateCalculatedContribution()">
                                <span id="savingsRateDisplay" class="text-sm font-medium text-white w-12 text-right">15%</span>
                            </div>
                            <div class="flex items-center justify-between text-xs">
                                <span class="text-gray-500">From salary:</span>
                                <span id="calculatedContribution" class="text-green-400 font-medium">$900/mo</span>
                            </div>
                            <!-- Additional Monthly Savings -->
                            <div class="pt-2 border-t border-gray-600">
                                <label class="text-xs text-gray-400 mb-1 block">
                                    + Additional savings (bonuses, windfalls, etc.)
                                </label>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500 text-sm">$</span>
                                    <input type="number" id="additionalSavings" value="0" min="0"
                                        class="flex-1 bg-gray-600 border-none rounded px-3 py-2 text-white text-sm focus:ring-2 focus:ring-blue-500"
                                        placeholder="0" onchange="updateCalculatedContribution()">
                                    <span class="text-gray-500 text-sm">/mo</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between text-sm font-medium pt-2 border-t border-gray-600">
                                <span class="text-gray-300">Total monthly savings:</span>
                                <span id="totalMonthlySavings" class="text-green-400">$900/mo</span>
                            </div>
                            <div id="savingsRateFeedback" class="text-xs text-gray-400"></div>
                        </div>
                    </div>
                </div>

                <!-- Risk Profile -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-3">Risk Profile</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <label class="flex items-center p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition">
                            <input type="radio" name="riskProfile" value="conservative" class="mr-2">
                            <div>
                                <div class="font-medium text-sm">Conservative</div>
                                <div class="text-xs text-gray-400">6% / 10% vol</div>
                            </div>
                        </label>
                        <label class="flex items-center p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition">
                            <input type="radio" name="riskProfile" value="moderate" class="mr-2">
                            <div>
                                <div class="font-medium text-sm">Moderate</div>
                                <div class="text-xs text-gray-400">8% / 13% vol</div>
                            </div>
                        </label>
                        <label class="flex items-center p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition">
                            <input type="radio" name="riskProfile" value="aggressive" checked class="mr-2">
                            <div>
                                <div class="font-medium text-sm">Aggressive</div>
                                <div class="text-xs text-gray-400">10% / 16% vol</div>
                            </div>
                        </label>
                        <label class="flex items-center p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 transition">
                            <input type="radio" name="riskProfile" value="very_aggressive" class="mr-2">
                            <div>
                                <div class="font-medium text-sm">Very Aggressive</div>
                                <div class="text-xs text-gray-400">12% / 20% vol</div>
                            </div>
                        </label>
                        <label class="flex items-center p-3 bg-yellow-900/50 border border-yellow-600/50 rounded-lg cursor-pointer hover:bg-yellow-800/50 transition col-span-2 md:col-span-4">
                            <input type="radio" name="riskProfile" value="rentech" class="mr-2">
                            <div>
                                <div class="font-medium text-sm text-yellow-300">RenTech Medallion</div>
                                <div class="text-xs text-yellow-400">40% / 20% vol (Sharpe ~2) - Illustrative only, not accessible to retail investors</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Monthly Income (Optional - shown only in direct mode) -->
                <div id="incomeInputSection">
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        Monthly Income <span class="text-gray-500">(optional, for sustainability check)</span>
                    </label>
                    <input type="number" id="monthlyIncome" value="" min="0" placeholder="Leave blank to skip"
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button type="button" onclick="toggleIncomeGuide()" class="text-xs text-blue-400 hover:text-blue-300 mt-2 underline">
                        How to think about income risk ‚Üí
                    </button>
                </div>

                <!-- Income Risk Guide (hidden by default) -->
                <div id="incomeGuide" class="hidden bg-gray-700/50 border border-gray-600 rounded-lg p-4 text-sm">
                    <div class="font-medium text-gray-200 mb-2">üí° Risk-Adjusting Your Income</div>
                    <p class="text-gray-400 mb-3">
                        Just like investments, income has volatility. Your "expected" income growth should be risk-adjusted:
                    </p>
                    <div class="bg-gray-800 rounded p-2 font-mono text-xs text-center mb-3">
                        Effective Growth ‚âà Average Growth ‚àí ¬Ω √ó Volatility¬≤
                    </div>
                    <table class="w-full text-xs mb-3">
                        <thead class="text-gray-400">
                            <tr><th class="text-left py-1">Job Type</th><th class="text-right">Avg Growth</th><th class="text-right">Volatility</th><th class="text-right">Effective</th></tr>
                        </thead>
                        <tbody class="text-gray-300">
                            <tr><td class="py-1">Government/Tenured</td><td class="text-right">3%</td><td class="text-right">5%</td><td class="text-right text-green-400">~2.9%</td></tr>
                            <tr><td class="py-1">Large Corp Salaried</td><td class="text-right">5%</td><td class="text-right">15%</td><td class="text-right text-green-400">~3.9%</td></tr>
                            <tr><td class="py-1">Sales/Commission</td><td class="text-right">10%</td><td class="text-right">40%</td><td class="text-right text-yellow-400">~2.0%</td></tr>
                            <tr><td class="py-1">Startup/Founder</td><td class="text-right">20%</td><td class="text-right">80%</td><td class="text-right text-red-400">~-12%</td></tr>
                            <tr><td class="py-1">Freelance/Gig</td><td class="text-right">8%</td><td class="text-right">50%</td><td class="text-right text-red-400">~-4.5%</td></tr>
                        </tbody>
                    </table>
                    <p class="text-gray-500 text-xs">
                        <strong>Caveat:</strong> This is illustrative. Real income paths aren't log-normal, and human capital has options (you can switch jobs, upskill).
                        But the intuition holds: high variance in income is costly for planning.
                    </p>
                </div>

                <!-- Submit -->
                <button type="submit" id="analyzeBtn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg transition duration-200 flex items-center justify-center">
                    <span id="btnText">Analyze My Goal</span>
                    <svg id="spinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </form>
        </div>

        <!-- Results (hidden initially) -->
        <div id="results" class="hidden space-y-6">
            <!-- Status Banner -->
            <div id="statusBanner" class="rounded-lg p-4 flex items-center justify-between">
                <div class="flex items-center">
                    <span id="statusEmoji" class="text-2xl mr-3"></span>
                    <div>
                        <div id="statusText" class="font-bold text-lg"></div>
                        <div id="probText" class="text-sm opacity-90"></div>
                    </div>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-gray-800 rounded-lg p-4">
                    <div class="text-sm text-gray-400 mb-1">Required Monthly</div>
                    <div id="requiredMonthly" class="text-2xl font-bold text-white"></div>
                    <div id="contributionGap" class="text-sm mt-1"></div>
                </div>
                <div class="bg-gray-800 rounded-lg p-4">
                    <div class="text-sm text-gray-400 mb-1">80% Confidence Floor</div>
                    <div id="percentile20" class="text-2xl font-bold text-white"></div>
                    <div class="text-sm text-gray-400 mt-1">Worst likely outcome</div>
                </div>
                <div class="bg-gray-800 rounded-lg p-4">
                    <div class="text-sm text-gray-400 mb-1">Median Outcome</div>
                    <div id="percentile50" class="text-2xl font-bold text-white"></div>
                    <div class="text-sm text-gray-400 mt-1">Expected result</div>
                </div>
            </div>

            <!-- Sustainable Income from Target -->
            <div class="bg-gray-800 rounded-lg p-4">
                <div class="font-medium mb-3 flex items-center">
                    <span class="mr-2">üè¶</span> Your Target Supports This Annual Income
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-700/50 rounded-lg p-3">
                        <div class="text-xs text-gray-400 mb-1">Conservative (3% SWR)</div>
                        <div id="sustainableConservative" class="text-xl font-bold text-green-400"></div>
                        <div class="text-xs text-gray-500 mt-1">30+ year horizon, inflation-adjusted</div>
                    </div>
                    <div class="bg-gray-700/50 rounded-lg p-3">
                        <div class="text-xs text-gray-400 mb-1">Moderate (4% SWR)</div>
                        <div id="sustainableModerate" class="text-xl font-bold text-blue-400"></div>
                        <div class="text-xs text-gray-500 mt-1">Traditional "4% rule"</div>
                    </div>
                </div>
                <div class="text-xs text-gray-500 mt-3">
                    <strong>Safe Withdrawal Rate (SWR)</strong> = annual spending as % of portfolio at retirement.
                    Lower SWR = more conservative, higher chance of not running out.
                    <br><br>
                    <strong>Note:</strong> These are <em>real</em> (inflation-adjusted) dollars ‚Äî the purchasing power stays constant.
                    The actual dollar amount you withdraw increases each year with inflation.
                </div>
            </div>

            <!-- Flags -->
            <div id="flagsContainer" class="bg-gray-800 rounded-lg p-4">
                <div class="font-medium mb-2 flex items-center">
                    <span class="mr-2">‚ö†Ô∏è</span> Flags
                </div>
                <ul id="flagsList" class="space-y-1 text-sm text-gray-300"></ul>
            </div>

            <!-- Recommendations -->
            <div class="bg-gray-800 rounded-lg p-4">
                <div class="font-medium mb-2 flex items-center">
                    <span class="mr-2">üí°</span> Recommendations
                </div>
                <ul id="recommendationsList" class="space-y-2 text-sm text-gray-300"></ul>
            </div>

            <!-- Projection Chart -->
            <div class="bg-gray-800 rounded-lg p-4">
                <div class="font-medium mb-4">üìà Wealth Projection</div>
                <div class="h-64">
                    <canvas id="projectionChart"></canvas>
                </div>
            </div>

            <!-- Key Considerations (Educational) -->
            <div class="bg-gray-800 rounded-lg p-4">
                <button onclick="toggleSection('goalConsiderations')" class="w-full flex items-center justify-between font-medium">
                    <span>üìö Key Considerations for Your Plan</span>
                    <span id="goalConsiderationsArrow" class="transform transition-transform">‚ñº</span>
                </button>
                <div id="goalConsiderations" class="hidden mt-4 space-y-4 text-sm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-700/50 p-3 rounded">
                            <div class="font-medium text-yellow-400 mb-1">‚ö†Ô∏è Sequence of Returns Risk</div>
                            <p class="text-gray-300"><strong>Accumulation phase:</strong> Bad returns early are actually <em>helpful</em> ‚Äî you buy more shares cheap (dollar-cost averaging). <strong>Withdrawal phase:</strong> Bad returns early are devastating ‚Äî you sell at lows, depleting your portfolio faster.</p>
                        </div>
                        <div class="bg-gray-700/50 p-3 rounded">
                            <div class="font-medium text-blue-400 mb-1">üí∞ Tax Considerations</div>
                            <p class="text-gray-300">401(k)/IRA = pre-tax contributions, taxed on withdrawal. Roth = post-tax, tax-free growth. Taxable accounts have capital gains. Plan accordingly.</p>
                        </div>
                        <div class="bg-gray-700/50 p-3 rounded">
                            <div class="font-medium text-red-400 mb-1">üìâ Inflation Erosion</div>
                            <p class="text-gray-300">At 3% inflation, $1M in 30 years has the purchasing power of ~$412K today. Always think in "real" (inflation-adjusted) terms.</p>
                        </div>
                        <div class="bg-gray-700/50 p-3 rounded">
                            <div class="font-medium text-green-400 mb-1">üë§ Human Capital</div>
                            <p class="text-gray-300">Your ability to earn income is an asset. Early career = high human capital, low financial capital. Invest aggressively when young.</p>
                        </div>
                        <div class="bg-gray-700/50 p-3 rounded">
                            <div class="font-medium text-purple-400 mb-1">üè¶ Emergency Fund First</div>
                            <p class="text-gray-300">Keep 3-6 months expenses in cash before investing. This prevents selling investments at bad times to cover emergencies.</p>
                        </div>
                        <div class="bg-gray-700/50 p-3 rounded">
                            <div class="font-medium text-orange-400 mb-1">‚öñÔ∏è Debt vs Investing</div>
                            <p class="text-gray-300">High-interest debt (>7%) should be paid first. Low-interest debt (mortgage at 3%) can coexist with investing if returns exceed the rate.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Button -->
            <div class="flex justify-center">
                <button onclick="exportGoalToExcel()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg flex items-center gap-2 transition">
                    <span>üìä</span> Export to Excel (with formulas)
                </button>
            </div>

            <!-- Disclaimer -->
            <div class="text-xs text-gray-500 text-center p-4 bg-gray-800 rounded-lg">
                <strong>Disclaimer:</strong> This tool provides educational estimates only and does not constitute financial advice.
                Projections are based on historical market assumptions and do not guarantee future results.
                Consult a qualified financial advisor before making investment decisions.
            </div>
        </div>

        <!-- FIRE Results (hidden initially) -->
        <div id="fireResults" class="hidden space-y-6">
            <!-- FIRE Number Banner -->
            <div class="bg-gradient-to-r from-orange-600 to-red-600 rounded-lg p-6">
                <div class="text-center">
                    <div class="text-orange-200 text-sm mb-1">üî• Your FIRE Number</div>
                    <div id="fireNumber" class="text-4xl font-bold text-white mb-2">$1,200,000</div>
                    <div class="text-orange-200 text-sm">
                        Based on <span id="fireExpensesSummary">$48,000</span>/yr expenses at <span id="fireSWRSummary">4%</span> SWR
                    </div>
                    <div class="text-orange-200/70 text-xs mt-1">
                        Supports <span id="fireRetirementYearsSummary">30</span> years of retirement
                    </div>
                </div>
            </div>

            <!-- Investment Assumptions -->
            <div class="bg-gray-800 rounded-lg p-4">
                <div class="text-sm text-gray-400 mb-2">üìà Investment Assumptions Used</div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div>
                        <div class="text-xs text-gray-500">Risk Profile</div>
                        <div id="fireRiskProfile" class="font-medium text-white capitalize">Aggressive</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500">Nominal Return</div>
                        <div id="fireNominalReturn" class="font-medium text-green-400">10%</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500">Inflation</div>
                        <div id="fireInflationUsed" class="font-medium text-red-400">3%</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500">Real Return</div>
                        <div id="fireRealReturn" class="font-medium text-blue-400">7%</div>
                    </div>
                </div>
                <div class="text-xs text-gray-500 mt-2 text-center">
                    Change risk profile above to see how it affects your FIRE date
                </div>
            </div>

            <!-- What This Means (Educational) -->
            <div class="bg-gray-800 rounded-lg p-4">
                <div class="font-medium mb-2">üìö What This Means</div>
                <div class="text-sm text-gray-300 space-y-2">
                    <p>
                        <strong>FIRE Number</strong> = Annual Expenses √∑ Safe Withdrawal Rate.
                        With $<span id="eduExpenses">48,000</span>/yr expenses and <span id="eduSWR">4%</span> SWR,
                        you need $<span id="eduFireNum">1,200,000</span> invested.
                    </p>
                    <p>
                        At <span id="eduSWR2">4%</span> withdrawal, you'll take
                        $<span id="eduAnnualWithdraw">48,000</span>/yr from your portfolio.
                        Historically, this strategy has survived <span id="eduSuccessRate">95%+</span> of
                        <span id="eduRetYears">30</span>-year periods, even through recessions.
                    </p>
                    <p class="text-yellow-400/80">
                        <strong>Caveat:</strong> Past performance doesn't guarantee future results.
                        Consider a <span id="eduBufferPct">10-20%</span> buffer above your FIRE number.
                    </p>
                </div>
            </div>

            <!-- Progress & Timeline -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-800 rounded-lg p-4">
                    <div class="text-sm text-gray-400 mb-2">Progress to FIRE</div>
                    <div class="flex items-end gap-3">
                        <div id="fireProgress" class="text-3xl font-bold text-orange-400">4.2%</div>
                        <div class="text-gray-500 text-sm pb-1">of the way there</div>
                    </div>
                    <div class="mt-3 h-3 bg-gray-700 rounded-full overflow-hidden">
                        <div id="fireProgressBar" class="h-full bg-gradient-to-r from-orange-500 to-red-500 rounded-full transition-all duration-500" style="width: 4.2%"></div>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-lg p-4">
                    <div class="text-sm text-gray-400 mb-2">Projected FIRE Date</div>
                    <div id="fireDate" class="text-2xl font-bold text-white mb-1">Age 52</div>
                    <div id="fireDateDetails" class="text-sm text-gray-400">22 years from now (2048)</div>
                </div>
            </div>

            <!-- Scenario Comparison -->
            <div class="bg-gray-800 rounded-lg p-4">
                <div class="font-medium mb-4 flex items-center">
                    <span class="mr-2">üìä</span> What-If Scenarios
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="bg-gray-700/50 rounded-lg p-3">
                        <div class="text-gray-400 mb-1">Save 25% More</div>
                        <div id="scenarioSaveMore" class="text-lg font-bold text-green-400">Age 48</div>
                        <div id="scenarioSaveMoreDiff" class="text-xs text-green-400">4 years earlier</div>
                    </div>
                    <div class="bg-gray-700/50 rounded-lg p-3">
                        <div class="text-gray-400 mb-1">Spend 25% Less</div>
                        <div id="scenarioSpendLess" class="text-lg font-bold text-blue-400">Age 47</div>
                        <div id="scenarioSpendLessDiff" class="text-xs text-blue-400">5 years earlier</div>
                    </div>
                    <div class="bg-gray-700/50 rounded-lg p-3">
                        <div class="text-gray-400 mb-1">Both Changes</div>
                        <div id="scenarioBoth" class="text-lg font-bold text-purple-400">Age 43</div>
                        <div id="scenarioBothDiff" class="text-xs text-purple-400">9 years earlier</div>
                    </div>
                </div>
            </div>

            <!-- FIRE Projection Chart -->
            <div class="bg-gray-800 rounded-lg p-4">
                <div class="font-medium mb-4">üìà Path to Financial Independence</div>
                <div class="h-64">
                    <canvas id="fireChart"></canvas>
                </div>
            </div>

            <!-- FIRE Considerations (Educational) -->
            <div class="bg-gray-800 rounded-lg p-4">
                <button onclick="toggleSection('fireConsiderations')" class="w-full flex items-center justify-between font-medium">
                    <span>üìö Key Considerations for Early Retirement</span>
                    <span id="fireConsiderationsArrow" class="transform transition-transform">‚ñº</span>
                </button>
                <div id="fireConsiderations" class="hidden mt-4 space-y-4 text-sm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-700/50 p-3 rounded">
                            <div class="font-medium text-red-400 mb-1">üè• Healthcare Gap</div>
                            <p class="text-gray-300">Medicare starts at 65. If retiring earlier, budget $500-1500/month for health insurance. This is often the biggest FIRE expense surprise.</p>
                        </div>
                        <div class="bg-gray-700/50 p-3 rounded">
                            <div class="font-medium text-blue-400 mb-1">üèõÔ∏è Social Security</div>
                            <p class="text-gray-300">You can claim at 62 (reduced) or wait until 70 (maximum). Each year you delay past 67 increases benefits ~8%. Factor this into late-retirement projections.</p>
                        </div>
                        <div class="bg-gray-700/50 p-3 rounded">
                            <div class="font-medium text-yellow-400 mb-1">üìâ Sequence Risk is Critical</div>
                            <p class="text-gray-300">A bear market in years 1-5 of retirement can devastate your portfolio. Consider a 2-3 year cash buffer or flexible withdrawal strategy.</p>
                        </div>
                        <div class="bg-gray-700/50 p-3 rounded">
                            <div class="font-medium text-green-400 mb-1">üîÑ Variable Withdrawals</div>
                            <p class="text-gray-300">Instead of fixed 4%, use guardrails: cut spending 10% if portfolio drops 20%, increase 10% if it rises 50%. This dramatically improves success rates.</p>
                        </div>
                        <div class="bg-gray-700/50 p-3 rounded">
                            <div class="font-medium text-purple-400 mb-1">üíº Tax Optimization</div>
                            <p class="text-gray-300">Roth conversion ladder: convert 401(k) to Roth in low-income years, access 5 years later tax-free. Can significantly reduce lifetime taxes.</p>
                        </div>
                        <div class="bg-gray-700/50 p-3 rounded">
                            <div class="font-medium text-orange-400 mb-1">üåç Geographic Arbitrage</div>
                            <p class="text-gray-300">Moving to lower cost-of-living areas (domestically or internationally) can reduce your FIRE number by 30-50%. Popular: Portugal, Mexico, Thailand, US South.</p>
                        </div>
                        <div class="bg-gray-700/50 p-3 rounded">
                            <div class="font-medium text-cyan-400 mb-1">‚òï Coast FIRE / Barista FIRE</div>
                            <p class="text-gray-300">Coast: Save enough that compound growth hits your FIRE number by 65, then stop saving. Barista: Part-time work covers expenses while investments grow.</p>
                        </div>
                        <div class="bg-gray-700/50 p-3 rounded">
                            <div class="font-medium text-pink-400 mb-1">üß† One More Year Syndrome</div>
                            <p class="text-gray-300">The psychological trap of always wanting "one more year" of savings. At some point, time > money. Define your "enough" number and stick to it.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Button -->
            <div class="flex justify-center">
                <button onclick="exportFIREToExcel()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg flex items-center gap-2 transition">
                    <span>üìä</span> Export to Excel (with formulas)
                </button>
            </div>

            <!-- FIRE Disclaimer -->
            <div class="text-xs text-gray-500 text-center p-4 bg-gray-800 rounded-lg">
                <strong>FIRE Assumptions:</strong> Uses the 4% rule (or your selected SWR) based on the Trinity Study.
                Actual results will vary based on market conditions, sequence of returns risk, and lifestyle changes.
                Consider consulting a fee-only fiduciary advisor for personalized planning.
            </div>
        </div>
    </div>

    <script>
        // API URL - change this when deploying
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:8000'
            : '';  // Same origin in production

        let chart = null;

        function toggleIncomeGuide() {
            const guide = document.getElementById('incomeGuide');
            guide.classList.toggle('hidden');
        }

        let usingSalaryMode = false;

        function toggleSavingsMode() {
            usingSalaryMode = !usingSalaryMode;
            const directMode = document.getElementById('directContributionMode');
            const salaryMode = document.getElementById('salaryRateMode');
            const incomeSection = document.getElementById('incomeInputSection');
            const toggleText = document.getElementById('savingsModeToggle');

            if (usingSalaryMode) {
                directMode.classList.add('hidden');
                salaryMode.classList.remove('hidden');
                incomeSection.classList.add('hidden'); // Hide separate income field
                toggleText.textContent = '‚Üê Switch to direct amount';
                updateCalculatedContribution();
            } else {
                directMode.classList.remove('hidden');
                salaryMode.classList.add('hidden');
                incomeSection.classList.remove('hidden');
                toggleText.textContent = 'Switch to salary + rate ‚Üí';
            }
        }

        let calculatorMode = 'goal';
        let fireChart = null;

        // Help content for each field
        const helpContent = {
            currentSavings: {
                title: 'Current Savings / Portfolio',
                content: `<p class="mb-2">This is your <strong>total investable assets today</strong>:</p>
                    <ul class="list-disc list-inside text-sm space-y-1 text-gray-300">
                        <li>401(k) and 403(b) balances</li>
                        <li>IRA accounts (Traditional & Roth)</li>
                        <li>Taxable brokerage accounts</li>
                        <li>HSA invested balance</li>
                    </ul>
                    <p class="mt-2 text-yellow-400 text-sm">Don't include: Home equity, cars, emergency fund (3-6 months expenses), or debt.</p>`
            },
            targetGoal: {
                title: 'Target Goal - Future vs Today\'s Dollars',
                content: `<p class="mb-2"><strong>Today's dollars (real):</strong> Purchasing power equivalent. If you say "$1M in today's dollars" with 3% inflation over 30 years, the actual number you need is ~$2.4M nominal.</p>
                    <p class="mb-2"><strong>Future dollars (nominal):</strong> The actual dollar amount you'll see in your account. $1M nominal in 30 years buys less than $1M today due to inflation.</p>
                    <p class="mt-2 text-blue-400 text-sm">Recommendation: Use "today's dollars" to think in current purchasing power. The calculator adjusts for inflation internally.</p>`
            },
            yearsToGoal: {
                title: 'Years Until Goal',
                content: `<p class="mb-2">How many years until you need to access this money?</p>
                    <ul class="list-disc list-inside text-sm space-y-1 text-gray-300">
                        <li><strong>Retirement:</strong> Years until you stop working</li>
                        <li><strong>House down payment:</strong> Years until purchase</li>
                        <li><strong>Education:</strong> Years until tuition is due</li>
                    </ul>
                    <p class="mt-2 text-sm">Longer horizons allow more aggressive investing (more time to recover from downturns).</p>`
            },
            retirementYears: {
                title: 'Years in Retirement',
                content: `<p class="mb-2">How long your money needs to last <strong>after</strong> you retire.</p>
                    <p class="mb-2">This affects safe withdrawal rate research:</p>
                    <ul class="list-disc list-inside text-sm space-y-1 text-gray-300">
                        <li><strong>30 years:</strong> Traditional retirement (65‚Üí95). 4% SWR is well-tested.</li>
                        <li><strong>40 years:</strong> Early retirement (55‚Üí95). Consider 3.5% SWR.</li>
                        <li><strong>50+ years:</strong> Very early FIRE (45‚Üí95+). Consider 3% SWR or variable withdrawal.</li>
                    </ul>
                    <p class="mt-2 text-yellow-400 text-sm">Longer retirements face more sequence-of-returns risk and need lower withdrawal rates.</p>`
            },
            retirementDuration: {
                title: 'Retirement Duration & SWR',
                content: `<p class="mb-2">The famous "4% rule" was based on 30-year retirements.</p>
                    <p class="mb-2"><strong>Recommended SWR by duration:</strong></p>
                    <table class="text-sm w-full mt-2">
                        <tr class="border-b border-gray-600"><td class="py-1">20 years</td><td class="text-right">4.5-5%</td></tr>
                        <tr class="border-b border-gray-600"><td class="py-1">30 years</td><td class="text-right">4%</td></tr>
                        <tr class="border-b border-gray-600"><td class="py-1">40 years</td><td class="text-right">3.5%</td></tr>
                        <tr><td class="py-1">50+ years</td><td class="text-right">3% or lower</td></tr>
                    </table>
                    <p class="mt-2 text-sm">Source: Trinity Study, updated research by Wade Pfau, Kitces, ERN.</p>`
            },
            monthlyExpenses: {
                title: 'Monthly Expenses in Retirement',
                content: `<p class="mb-2">Your expected <strong>monthly spending</strong> after you retire, in today's dollars.</p>
                    <p class="mb-2">Consider:</p>
                    <ul class="list-disc list-inside text-sm space-y-1 text-gray-300">
                        <li>Housing (rent/mortgage, property tax, maintenance)</li>
                        <li>Healthcare (often increases in retirement)</li>
                        <li>Food, utilities, transportation</li>
                        <li>Travel, hobbies, entertainment</li>
                    </ul>
                    <p class="mt-2 text-blue-400 text-sm">Common rule: Plan for 70-80% of pre-retirement spending. But FIRE folks often spend MORE early in retirement (travel, hobbies).</p>`
            },
            monthlyInvestment: {
                title: 'Monthly Investment',
                content: `<p class="mb-2">How much you invest <strong>each month</strong> toward your goal.</p>
                    <p class="mb-2">This is your income minus expenses, including:</p>
                    <ul class="list-disc list-inside text-sm space-y-1 text-gray-300">
                        <li>401(k) contributions (including employer match)</li>
                        <li>IRA contributions</li>
                        <li>Taxable brokerage investments</li>
                    </ul>
                    <p class="mt-2 text-sm">Your savings rate = Monthly Investment √∑ Monthly Income</p>`
            },
            swr: {
                title: 'Safe Withdrawal Rate (SWR)',
                content: `<p class="mb-2">The percentage of your portfolio you withdraw each year in retirement.</p>
                    <p class="mb-2"><strong>The 4% Rule:</strong> Withdraw 4% in year 1, then adjust for inflation each year. Historically succeeded 95%+ of the time over 30 years.</p>
                    <ul class="list-disc list-inside text-sm space-y-1 text-gray-300">
                        <li><strong>3%:</strong> Very conservative. Almost never fails.</li>
                        <li><strong>4%:</strong> Traditional. Good for 30-year retirements.</li>
                        <li><strong>5%:</strong> Aggressive. Higher failure risk in bad markets.</li>
                    </ul>
                    <p class="mt-2 text-yellow-400 text-sm">FIRE Number = Annual Expenses √∑ SWR. Lower SWR = higher FIRE number = more safety.</p>`
            },
            inflation: {
                title: 'Expected Inflation',
                content: `<p class="mb-2">The annual rate at which prices increase, eroding your purchasing power.</p>
                    <ul class="list-disc list-inside text-sm space-y-1 text-gray-300">
                        <li><strong>2%:</strong> Fed's target rate</li>
                        <li><strong>3%:</strong> Historical US average (1926-2023)</li>
                        <li><strong>4-5%:</strong> Higher inflation environment</li>
                    </ul>
                    <p class="mt-2 text-sm"><strong>Real return</strong> = Nominal return - Inflation</p>
                    <p class="text-sm">If your portfolio returns 10% but inflation is 3%, your real return is ~7%.</p>`
            },
            realVsNominal: {
                title: 'Real vs Nominal Dollars',
                content: `<div class="space-y-3">
                    <div class="bg-blue-900/30 p-3 rounded">
                        <p class="font-bold text-blue-300">Nominal Dollars (Future Value)</p>
                        <p class="text-sm">The actual number on your bank statement. $1,000,000 nominal means you'll see "$1,000,000" in your account.</p>
                        <p class="text-sm mt-1 text-gray-400">Problem: Inflation erodes purchasing power. $1M in 30 years buys less than $1M today.</p>
                    </div>
                    <div class="bg-green-900/30 p-3 rounded">
                        <p class="font-bold text-green-300">Real Dollars (Today's Purchasing Power)</p>
                        <p class="text-sm">Adjusted for inflation. "$1M in today's dollars" means future wealth that buys what $1M buys today.</p>
                        <p class="text-sm mt-1 text-gray-400">With 3% inflation over 30 years, you'd need ~$2.4M nominal to have $1M real.</p>
                    </div>
                    <div class="bg-gray-700 p-3 rounded">
                        <p class="font-bold">Example: Planning for $50K/year spending</p>
                        <table class="text-sm w-full mt-2">
                            <tr class="border-b border-gray-600">
                                <td class="py-1">Today</td>
                                <td class="text-right">$50,000/yr</td>
                            </tr>
                            <tr class="border-b border-gray-600">
                                <td class="py-1">In 30 years (nominal, 3% inflation)</td>
                                <td class="text-right">$121,000/yr</td>
                            </tr>
                            <tr>
                                <td class="py-1">In 30 years (real)</td>
                                <td class="text-right">$50,000/yr (same purchasing power)</td>
                            </tr>
                        </table>
                    </div>
                    <p class="text-yellow-400 text-sm">üí° Recommendation: Think in "today's dollars" (real). It's more intuitive - you know what $50K buys today.</p>
                </div>`
            },
            glossary: {
                title: 'Financial Terms Glossary',
                content: `<div class="space-y-3 text-sm">
                    <div class="border-b border-gray-700 pb-2">
                        <p class="font-bold text-white">FIRE</p>
                        <p class="text-gray-300">Financial Independence, Retire Early. Having enough invested that you can live off investment returns without working.</p>
                    </div>
                    <div class="border-b border-gray-700 pb-2">
                        <p class="font-bold text-white">SWR (Safe Withdrawal Rate)</p>
                        <p class="text-gray-300">The percentage of your portfolio you withdraw annually. 4% is the classic "rule" based on historical market data.</p>
                    </div>
                    <div class="border-b border-gray-700 pb-2">
                        <p class="font-bold text-white">FIRE Number</p>
                        <p class="text-gray-300">Annual expenses √∑ SWR. The portfolio size needed to sustain your lifestyle indefinitely.</p>
                    </div>
                    <div class="border-b border-gray-700 pb-2">
                        <p class="font-bold text-white">Real Return</p>
                        <p class="text-gray-300">Investment return after subtracting inflation. If stocks return 10% and inflation is 3%, real return is ~7%.</p>
                    </div>
                    <div class="border-b border-gray-700 pb-2">
                        <p class="font-bold text-white">Nominal vs Real</p>
                        <p class="text-gray-300">Nominal = actual dollar amount. Real = inflation-adjusted (purchasing power). $1M nominal in 30 years ‚â† $1M real.</p>
                    </div>
                    <div class="border-b border-gray-700 pb-2">
                        <p class="font-bold text-white">Sequence of Returns Risk</p>
                        <p class="text-gray-300">The risk that poor returns early in retirement deplete your portfolio faster than expected, even if average returns are fine.</p>
                    </div>
                    <div class="border-b border-gray-700 pb-2">
                        <p class="font-bold text-white">Geometric vs Arithmetic Return</p>
                        <p class="text-gray-300">Arithmetic = simple average of returns. Geometric = compound growth rate. Volatility creates a "drag" making geometric < arithmetic.</p>
                    </div>
                    <div>
                        <p class="font-bold text-white">Lean FIRE vs Fat FIRE</p>
                        <p class="text-gray-300">Lean FIRE = minimal expenses (~$40K/yr). Fat FIRE = comfortable lifestyle ($100K+/yr). Different FIRE numbers required.</p>
                    </div>
                </div>`
            }
        };

        function showHelp(topic) {
            const help = helpContent[topic];
            if (!help) return;

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'helpModal';
            modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg max-w-lg w-full max-h-[80vh] overflow-y-auto">
                    <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                        <h3 class="font-bold text-lg text-white">${help.title}</h3>
                        <button onclick="document.getElementById('helpModal').remove()" class="text-gray-400 hover:text-white text-xl">&times;</button>
                    </div>
                    <div class="p-4 text-gray-300">${help.content}</div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function updateTargetHelp() {
            // Legacy function - now handled by updateInflationAdjustedTarget
            updateInflationAdjustedTarget();
        }

        function setTargetType(type) {
            // Update hidden select for form value
            document.getElementById('targetValueType').value = type;

            // Update toggle button styles
            const todayBtn = document.getElementById('todayDollarsBtn');
            const futureBtn = document.getElementById('futureDollarsBtn');
            const todayExpl = document.getElementById('todayDollarsExplanation');
            const futureExpl = document.getElementById('futureDollarsExplanation');

            if (type === 'today') {
                todayBtn.classList.add('bg-blue-600', 'text-white');
                todayBtn.classList.remove('text-gray-400');
                futureBtn.classList.remove('bg-blue-600', 'text-white');
                futureBtn.classList.add('text-gray-400');
                todayExpl.classList.remove('hidden');
                futureExpl.classList.add('hidden');
            } else {
                futureBtn.classList.add('bg-blue-600', 'text-white');
                futureBtn.classList.remove('text-gray-400');
                todayBtn.classList.remove('bg-blue-600', 'text-white');
                todayBtn.classList.add('text-gray-400');
                futureExpl.classList.remove('hidden');
                todayExpl.classList.add('hidden');
            }

            // Recalculate displays
            updateInflationAdjustedTarget();
        }

        function updateInflationAdjustedTarget() {
            const valueType = document.getElementById('targetValueType').value;
            const targetVal = parseFloat(document.getElementById('targetWealth').value) || 0;
            const years = parseInt(document.getElementById('yearsToGoal').value) || 30;

            // Get inflation from inline input if visible, otherwise from slider
            let inflation;
            const inlineInflation = document.getElementById('goalInflationInline');
            const sliderInflation = document.getElementById('goalInflation');

            if (valueType === 'today' && inlineInflation) {
                inflation = parseFloat(inlineInflation.value) || 3;
                // Sync slider with inline input
                if (sliderInflation) {
                    sliderInflation.value = inflation;
                    document.getElementById('goalInflationDisplay').textContent = inflation + '%';
                }
            } else {
                inflation = parseFloat(sliderInflation?.value) || 3;
                // Sync inline with slider
                if (inlineInflation) {
                    inlineInflation.value = inflation;
                }
            }

            const inflationFactor = Math.pow(1 + inflation / 100, years);

            // Update years display
            const yearsDisplay = document.getElementById('yearsDisplay');
            if (yearsDisplay) yearsDisplay.textContent = years;

            if (valueType === 'today') {
                // User entered today's dollars - need to inflate to future value
                const nominalTarget = targetVal * inflationFactor;

                // Update "Today's buying power" explanation
                const targetInToday = document.getElementById('targetInTodayTerms');
                if (targetInToday) targetInToday.textContent = targetVal.toLocaleString();

                const nominalDisplay = document.getElementById('nominalTargetDisplay');
                if (nominalDisplay) nominalDisplay.textContent = '$' + nominalTarget.toLocaleString(undefined, { maximumFractionDigits: 0 });

                // Store for calculations
                const targetExpl = document.getElementById('targetExplanation');
                if (targetExpl) targetExpl.dataset.nominalTarget = nominalTarget;
            } else {
                // User entered future (nominal) dollars directly
                const realValue = targetVal / inflationFactor;

                // Update "Actual future amount" explanation
                const targetInFuture = document.getElementById('targetInFutureTerms');
                if (targetInFuture) targetInFuture.textContent = targetVal.toLocaleString();

                const realDisplay = document.getElementById('realValueDisplay');
                if (realDisplay) realDisplay.textContent = '$' + realValue.toLocaleString(undefined, { maximumFractionDigits: 0 });

                // Update the inflation assumption text in future dollars view
                const futureExpl = document.getElementById('futureDollarsExplanation');
                if (futureExpl) {
                    const assumptionText = futureExpl.querySelector('.text-gray-500');
                    if (assumptionText) assumptionText.textContent = `(assuming ${inflation}% inflation over ${years} years)`;
                }

                // Store for calculations
                const targetExpl = document.getElementById('targetExplanation');
                if (targetExpl) targetExpl.dataset.nominalTarget = targetVal;
            }

            // Legacy element support
            const helpEl = document.getElementById('targetValueHelp');
            const adjustedSection = document.getElementById('inflationAdjustedTarget');
            if (helpEl && adjustedSection) {
                if (valueType === 'today') {
                    const nominalTarget = targetVal * inflationFactor;
                    helpEl.textContent = `You want purchasing power of $${targetVal.toLocaleString()} in today's terms`;
                    adjustedSection.classList.remove('hidden');
                    const oldNominalDisplay = adjustedSection.querySelector('#nominalTargetDisplay') || adjustedSection.querySelector('.font-bold');
                    if (oldNominalDisplay) oldNominalDisplay.textContent = '$' + nominalTarget.toLocaleString(undefined, { maximumFractionDigits: 0 });
                } else {
                    const realValue = targetVal / inflationFactor;
                    helpEl.textContent = `Worth ~$${realValue.toLocaleString(undefined, { maximumFractionDigits: 0 })} in today's purchasing power`;
                    adjustedSection.classList.add('hidden');
                }
            }
        }

        function getNominalTarget() {
            // Get the actual target to use in calculations (always nominal/future value)
            const valueType = document.getElementById('targetValueType').value;
            const targetVal = parseFloat(document.getElementById('targetWealth').value) || 0;

            if (valueType === 'today') {
                const years = parseInt(document.getElementById('yearsToGoal').value) || 30;
                const inflation = parseFloat(document.getElementById('goalInflation').value) || 3;
                return targetVal * Math.pow(1 + inflation / 100, years);
            } else {
                return targetVal;
            }
        }

        function adjustSWRForDuration() {
            const years = parseInt(document.getElementById('fireRetirementYears').value) || 30;
            const swrSlider = document.getElementById('fireSWR');
            const recommendationEl = document.getElementById('swrRecommendation');

            let recommendedSWR, message;
            if (years <= 20) {
                recommendedSWR = 4.5;
                message = '20-year horizon: 4.5% SWR is reasonable';
            } else if (years <= 30) {
                recommendedSWR = 4.0;
                message = '30-year horizon: Classic 4% rule applies';
            } else if (years <= 40) {
                recommendedSWR = 3.5;
                message = '40-year horizon: Consider 3.5% for safety';
            } else {
                recommendedSWR = 3.0;
                message = '50+ year horizon: Use 3% or lower for early FIRE';
            }

            recommendationEl.textContent = 'üí° ' + message;
            recommendationEl.classList.remove('hidden');
        }

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const arrow = document.getElementById(sectionId + 'Arrow');
            section.classList.toggle('hidden');
            arrow.classList.toggle('rotate-180');
        }

        // Store last results for export
        let lastGoalResult = null;
        let lastFireResult = null;

        function exportGoalToExcel() {
            if (!lastGoalResult) {
                alert('Please run an analysis first');
                return;
            }
            if (typeof XLSX === 'undefined') {
                alert('Export library not loaded. Please refresh the page or check your internet connection.');
                return;
            }

            const r = lastGoalResult;
            const wb = XLSX.utils.book_new();

            // Sheet 1: Summary
            const summaryData = [
                ['FINANCIAL GOAL ANALYSIS', '', '', ''],
                ['Generated:', new Date().toLocaleDateString(), '', ''],
                ['', '', '', ''],
                ['KEY INPUTS', '', 'KEY OUTPUTS', ''],
                ['Current Savings', r.input.currentWealth, 'Probability of Success', { t: 'n', v: r.probabilityOfSuccess, z: '0.0%' }],
                ['Target Goal', r.input.targetWealth, 'Status', r.status],
                ['Years to Goal', r.input.yearsToGoal, 'Required Monthly (80% success)', r.requiredMonthlyFor80Percent],
                ['Monthly Contribution', r.input.monthlyContribution, 'Contribution Gap', r.contributionGap],
                ['Risk Profile', r.input.riskProfile, '', ''],
                ['', '', '', ''],
                ['PROJECTIONS (with contributions)', '', '', ''],
                ['20th Percentile (Worst Likely)', r.projections.percentile20, '', ''],
                ['50th Percentile (Median)', r.projections.percentile50, '', ''],
                ['80th Percentile (Best Likely)', r.projections.percentile80, '', ''],
                ['', '', '', ''],
                ['SUSTAINABLE RETIREMENT INCOME', '', '', ''],
                ['Conservative (3% SWR)', r.sustainableIncome?.conservative || r.input.targetWealth * 0.03, '/year', ''],
                ['Moderate (4% SWR)', r.sustainableIncome?.moderate || r.input.targetWealth * 0.04, '/year', ''],
            ];
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            summaryWs['!cols'] = [{ wch: 30 }, { wch: 18 }, { wch: 30 }, { wch: 18 }];
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');

            // Sheet 2: Assumptions & Formulas
            const assumptionsData = [
                ['ASSUMPTIONS & METHODOLOGY', ''],
                ['', ''],
                ['Risk Profile Parameters', ''],
                ['Profile', r.input.riskProfile],
                ['Arithmetic Return', r.assumptions.arithmeticReturn],
                ['Geometric Return', r.assumptions.geometricReturn],
                ['Volatility (Std Dev)', r.assumptions.volatility],
                ['', ''],
                ['Key Formulas', ''],
                ['Geometric Return', '= Arithmetic Return - (Volatility¬≤ / 2)'],
                ['Future Value (Lump Sum)', '= PV √ó (1 + r)^n'],
                ['Future Value (Annuity)', '= PMT √ó ((1 + r)^n - 1) / r'],
                ['FIRE Number', '= Annual Expenses / SWR'],
                ['', ''],
                ['Monte Carlo Simulation', ''],
                ['Number of Simulations', '15,000'],
                ['Monthly Returns', '= Normal(Œº/12, œÉ/‚àö12)'],
                ['Success = paths where final wealth ‚â• target', ''],
            ];
            const assumptionsWs = XLSX.utils.aoa_to_sheet(assumptionsData);
            assumptionsWs['!cols'] = [{ wch: 35 }, { wch: 45 }];
            XLSX.utils.book_append_sheet(wb, assumptionsWs, 'Assumptions');

            // Sheet 3: Year-by-Year Projections with Formulas
            const years = r.input.yearsToGoal;
            const projData = [
                ['YEAR-BY-YEAR PROJECTIONS', '', '', '', '', ''],
                ['', '', '', '', '', ''],
                ['Inputs (referenced in formulas)', '', '', '', '', ''],
                ['Initial Investment', r.input.currentWealth, '', '', '', ''],
                ['Monthly Contribution', r.input.monthlyContribution, '', '', '', ''],
                ['Annual Contribution', { f: 'B5*12' }, '', '', '', ''],
                ['Expected Return (Geometric)', r.assumptions.geometricReturn, '', '', '', ''],
                ['', '', '', '', '', ''],
                ['Year', 'Start Balance', 'Annual Contribution', 'Growth', 'End Balance', 'Target'],
            ];

            // Add projection rows with formulas
            for (let y = 0; y <= years; y++) {
                const row = y + 10; // Excel row number (1-indexed)
                if (y === 0) {
                    projData.push([
                        0,
                        r.input.currentWealth,
                        0,
                        0,
                        r.input.currentWealth,
                        r.input.targetWealth
                    ]);
                } else {
                    projData.push([
                        y,
                        { f: `E${row}` }, // Start = previous End
                        { f: '$B$6' }, // Annual contribution (absolute reference)
                        { f: `(B${row + 1}+C${row + 1})*$B$7` }, // Growth = (Start+Contrib)*Rate
                        { f: `B${row + 1}+C${row + 1}+D${row + 1}` }, // End = Start+Contrib+Growth
                        r.input.targetWealth
                    ]);
                }
            }

            const projWs = XLSX.utils.aoa_to_sheet(projData);
            projWs['!cols'] = [{ wch: 8 }, { wch: 16 }, { wch: 18 }, { wch: 14 }, { wch: 16 }, { wch: 14 }];
            XLSX.utils.book_append_sheet(wb, projWs, 'Projections');

            // Sheet 4: Sensitivity Analysis
            const sensData = [
                ['SENSITIVITY ANALYSIS', '', '', ''],
                ['', '', '', ''],
                ['What-If Scenarios: Different Monthly Contributions', '', '', ''],
                ['Monthly Contribution', 'Annual', 'FV (Simple Est.)', 'Meets Target?'],
            ];

            const baseContrib = r.input.monthlyContribution;
            const contribScenarios = [0, baseContrib * 0.5, baseContrib, baseContrib * 1.25, baseContrib * 1.5, baseContrib * 2];
            contribScenarios.forEach((contrib, i) => {
                const row = i + 5;
                sensData.push([
                    contrib,
                    { f: `A${row}*12` },
                    { f: `${r.input.currentWealth}*(1+${r.assumptions.geometricReturn})^${years}+B${row}*((1+${r.assumptions.geometricReturn})^${years}-1)/${r.assumptions.geometricReturn}` },
                    { f: `IF(C${row}>=${r.input.targetWealth},"YES","NO")` }
                ]);
            });

            const sensWs = XLSX.utils.aoa_to_sheet(sensData);
            sensWs['!cols'] = [{ wch: 20 }, { wch: 12 }, { wch: 18 }, { wch: 14 }];
            XLSX.utils.book_append_sheet(wb, sensWs, 'Sensitivity');

            // Download
            XLSX.writeFile(wb, `Financial_Goal_Analysis_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }

        function exportFIREToExcel() {
            if (!lastFireResult) {
                alert('Please run a FIRE calculation first');
                return;
            }
            if (typeof XLSX === 'undefined') {
                alert('Export library not loaded. Please refresh the page or check your internet connection.');
                return;
            }

            const r = lastFireResult;
            const wb = XLSX.utils.book_new();

            // Sheet 1: FIRE Summary
            const summaryData = [
                ['FIRE (Financial Independence) ANALYSIS', '', ''],
                ['Generated:', new Date().toLocaleDateString(), ''],
                ['', '', ''],
                ['YOUR FIRE NUMBER', '', ''],
                ['Annual Expenses', r.annualExpenses, ''],
                ['Safe Withdrawal Rate (SWR)', r.swr / 100, ''],
                ['FIRE Number', { f: 'B5/B6' }, '‚Üê Annual Expenses √∑ SWR'],
                ['', '', ''],
                ['CURRENT PROGRESS', '', ''],
                ['Current Portfolio', r.currentWealth, ''],
                ['Progress to FIRE', { f: 'B10/B7' }, ''],
                ['Gap to FIRE', { f: 'B7-B10' }, ''],
                ['', '', ''],
                ['TIMELINE', '', ''],
                ['Current Age', r.currentAge, ''],
                ['Projected FIRE Age', Math.round(r.fireAge), ''],
                ['Years to FIRE', { f: 'B16-B15' }, ''],
                ['Retirement Duration', r.retirementYears, 'years'],
                ['', '', ''],
                ['INPUTS', '', ''],
                ['Monthly Investment', r.monthlyInvestment, ''],
                ['Expected Real Return', r.realReturn, '(after inflation)'],
            ];
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            summaryWs['!cols'] = [{ wch: 25 }, { wch: 18 }, { wch: 25 }];
            // Format percentage cells
            if (summaryWs['B6']) summaryWs['B6'].z = '0.0%';
            if (summaryWs['B11']) summaryWs['B11'].z = '0.0%';
            if (summaryWs['B22']) summaryWs['B22'].z = '0.0%';
            XLSX.utils.book_append_sheet(wb, summaryWs, 'FIRE Summary');

            // Sheet 2: Path to FIRE with formulas
            const pathData = [
                ['PATH TO FIRE', '', '', '', '', '', ''],
                ['', '', '', '', '', '', ''],
                ['Parameters (referenced below)', '', '', '', '', '', ''],
                ['Starting Portfolio', r.currentWealth, '', '', '', '', ''],
                ['Monthly Investment', r.monthlyInvestment, '', '', '', '', ''],
                ['Annual Investment', { f: 'B5*12' }, '', '', '', '', ''],
                ['Real Return', r.realReturn, '', '', '', '', ''],
                ['FIRE Target', r.fireNumber, '', '', '', '', ''],
                ['', '', '', '', '', '', ''],
                ['Year', 'Age', 'Start Balance', 'Annual Investment', 'Growth', 'End Balance', 'FIRE Target', 'Reached FIRE?'],
            ];

            const yearsToProject = Math.min(Math.ceil(r.monthsToFIRE / 12) + 5, 50);
            for (let y = 0; y <= yearsToProject; y++) {
                const row = y + 11;
                if (y === 0) {
                    pathData.push([
                        0,
                        r.currentAge,
                        r.currentWealth,
                        0,
                        0,
                        r.currentWealth,
                        r.fireNumber,
                        { f: `IF(F${row}>=$B$8,"YES","")` }
                    ]);
                } else {
                    pathData.push([
                        y,
                        { f: `B${row}+1` },
                        { f: `F${row}` },
                        { f: '$B$6' },
                        { f: `(C${row + 1}+D${row + 1})*$B$7` },
                        { f: `C${row + 1}+D${row + 1}+E${row + 1}` },
                        { f: '$B$8' },
                        { f: `IF(F${row + 1}>=$B$8,"YES","")` }
                    ]);
                }
            }

            const pathWs = XLSX.utils.aoa_to_sheet(pathData);
            pathWs['!cols'] = [{ wch: 6 }, { wch: 6 }, { wch: 14 }, { wch: 16 }, { wch: 12 }, { wch: 14 }, { wch: 14 }, { wch: 14 }];
            XLSX.utils.book_append_sheet(wb, pathWs, 'Path to FIRE');

            // Sheet 3: Scenarios Comparison
            const scenData = [
                ['SCENARIO COMPARISON', '', '', '', ''],
                ['', '', '', '', ''],
                ['Scenario', 'Monthly Invest', 'Monthly Expenses', 'FIRE Number', 'Years to FIRE'],
                ['Base Case', r.monthlyInvestment, r.annualExpenses / 12, r.fireNumber, Math.round(r.monthsToFIRE / 12)],
                ['Save 25% More', r.monthlyInvestment * 1.25, r.annualExpenses / 12, r.fireNumber, Math.round(r.scenarios.saveMore.months / 12)],
                ['Spend 25% Less', r.monthlyInvestment, r.annualExpenses * 0.75 / 12, r.scenarios.spendLess.fireNumber, Math.round(r.scenarios.spendLess.months / 12)],
                ['Both Changes', r.monthlyInvestment * 1.25, r.annualExpenses * 0.75 / 12, r.scenarios.spendLess.fireNumber, Math.round(r.scenarios.both.months / 12)],
                ['', '', '', '', ''],
                ['ANALYSIS', '', '', '', ''],
                ['Saving 25% more reaches FIRE', '', { f: 'E4-E5' }, 'years earlier', ''],
                ['Spending 25% less reaches FIRE', '', { f: 'E4-E6' }, 'years earlier', ''],
                ['Both together reaches FIRE', '', { f: 'E4-E7' }, 'years earlier', ''],
            ];
            const scenWs = XLSX.utils.aoa_to_sheet(scenData);
            scenWs['!cols'] = [{ wch: 25 }, { wch: 16 }, { wch: 18 }, { wch: 14 }, { wch: 14 }];
            XLSX.utils.book_append_sheet(wb, scenWs, 'Scenarios');

            // Sheet 4: Post-FIRE Withdrawal Projection
            const withdrawData = [
                ['POST-FIRE WITHDRAWAL PROJECTION', '', '', '', '', ''],
                ['', '', '', '', '', ''],
                ['Parameters', '', '', '', '', ''],
                ['Starting Portfolio (at FIRE)', r.fireNumber, '', '', '', ''],
                ['Annual Withdrawal', r.annualExpenses, '', '', '', ''],
                ['Withdrawal Rate', { f: 'B5/B4' }, '', '', '', ''],
                ['Expected Real Return (in retirement)', 0.04, '(typically lower, more conservative)', '', '', ''],
                ['Retirement Years', r.retirementYears, '', '', '', ''],
                ['', '', '', '', '', ''],
                ['Year', 'Age at FIRE +', 'Start Balance', 'Withdrawal', 'Growth', 'End Balance'],
            ];

            for (let y = 0; y <= r.retirementYears; y++) {
                const row = y + 11;
                if (y === 0) {
                    withdrawData.push([
                        0,
                        0,
                        r.fireNumber,
                        0,
                        0,
                        r.fireNumber
                    ]);
                } else {
                    withdrawData.push([
                        y,
                        y,
                        { f: `F${row}` },
                        { f: '$B$5' },
                        { f: `(C${row + 1}-D${row + 1})*$B$7` },
                        { f: `C${row + 1}-D${row + 1}+E${row + 1}` }
                    ]);
                }
            }

            const withdrawWs = XLSX.utils.aoa_to_sheet(withdrawData);
            withdrawWs['!cols'] = [{ wch: 6 }, { wch: 12 }, { wch: 16 }, { wch: 14 }, { wch: 12 }, { wch: 16 }];
            XLSX.utils.book_append_sheet(wb, withdrawWs, 'Post-FIRE Withdrawals');

            // Download
            XLSX.writeFile(wb, `FIRE_Analysis_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }

        function setCalculatorMode(mode) {
            calculatorMode = mode;
            const goalBtn = document.getElementById('goalModeBtn');
            const fireBtn = document.getElementById('fireModeBtn');
            const goalInputs = document.getElementById('goalModeInputs');
            const fireInputs = document.getElementById('fireModeInputs');
            const targetSection = document.getElementById('targetWealthSection');
            const yearsSection = document.getElementById('yearsSection');
            const results = document.getElementById('results');
            const fireResults = document.getElementById('fireResults');
            const analyzeBtn = document.getElementById('btnText');

            // Clear previous results when switching modes
            lastGoalResult = null;
            lastFireResult = null;

            if (mode === 'goal') {
                goalBtn.classList.add('bg-blue-600', 'text-white');
                goalBtn.classList.remove('text-gray-400');
                fireBtn.classList.remove('bg-orange-600', 'text-white');
                fireBtn.classList.add('text-gray-400');
                goalInputs.classList.remove('hidden');
                fireInputs.classList.add('hidden');
                targetSection.classList.remove('hidden');
                yearsSection.classList.remove('hidden');
                results.classList.add('hidden');
                fireResults.classList.add('hidden');
                analyzeBtn.textContent = 'Analyze My Goal';
            } else {
                fireBtn.classList.add('bg-orange-600', 'text-white');
                fireBtn.classList.remove('text-gray-400');
                goalBtn.classList.remove('bg-blue-600', 'text-white');
                goalBtn.classList.add('text-gray-400');
                goalInputs.classList.add('hidden');
                fireInputs.classList.remove('hidden');
                results.classList.add('hidden');
                fireResults.classList.add('hidden');
                analyzeBtn.textContent = 'Calculate FIRE Date';
                updateFireNumber();
            }
        }

        function updateFireNumber() {
            const monthlyExpenses = parseFloat(document.getElementById('fireMonthlyExpenses').value) || 0;
            const swr = parseFloat(document.getElementById('fireSWR').value) || 4;
            const annualExpenses = monthlyExpenses * 12;
            const fireNumber = annualExpenses / (swr / 100);

            document.getElementById('fireAnnualExpenses').textContent = annualExpenses.toLocaleString();
            document.getElementById('fireSWRDisplay').textContent = swr + '%';
        }

        function calculateFIRE() {
            const currentWealth = parseFloat(document.getElementById('fireCurrentWealth').value) || 0;
            const monthlyExpenses = parseFloat(document.getElementById('fireMonthlyExpenses').value) || 0;
            const monthlyInvestment = parseFloat(document.getElementById('fireMonthlyInvestment').value) || 0;
            const currentAge = parseFloat(document.getElementById('fireCurrentAge').value) || 30;
            const retirementYears = parseInt(document.getElementById('fireRetirementYears').value) || 30;
            const swr = parseFloat(document.getElementById('fireSWR').value) || 4;
            const inflation = parseFloat(document.getElementById('fireInflation').value) || 3;

            // Get selected risk profile return
            const riskProfile = document.querySelector('input[name="riskProfile"]:checked').value;
            const profiles = {
                conservative: 0.06,
                moderate: 0.08,
                aggressive: 0.10,
                very_aggressive: 0.12,
                rentech: 0.40
            };
            const nominalReturn = profiles[riskProfile] || 0.10;
            const realReturn = nominalReturn - (inflation / 100);

            // Calculate FIRE number (inflation-adjusted expenses)
            const annualExpenses = monthlyExpenses * 12;
            const fireNumber = annualExpenses / (swr / 100);

            // Calculate progress
            const progress = (currentWealth / fireNumber) * 100;

            // Calculate months to FIRE
            const monthsToFIRE = calculateMonthsToTarget(currentWealth, fireNumber, monthlyInvestment, realReturn);
            const fireAge = currentAge + (monthsToFIRE / 12);
            const fireYear = new Date().getFullYear() + Math.ceil(monthsToFIRE / 12);

            // Scenario calculations
            const monthsSaveMore = calculateMonthsToTarget(currentWealth, fireNumber, monthlyInvestment * 1.25, realReturn);
            const fireNumberSpendLess = (annualExpenses * 0.75) / (swr / 100);
            const monthsSpendLess = calculateMonthsToTarget(currentWealth, fireNumberSpendLess, monthlyInvestment, realReturn);
            const monthsBoth = calculateMonthsToTarget(currentWealth, fireNumberSpendLess, monthlyInvestment * 1.25, realReturn);

            return {
                fireNumber,
                annualExpenses,
                swr,
                retirementYears,
                progress,
                monthsToFIRE,
                fireAge,
                fireYear,
                currentAge,
                currentWealth,
                monthlyInvestment,
                riskProfile,
                nominalReturn,
                realReturn,
                inflation,
                scenarios: {
                    saveMore: { months: monthsSaveMore, age: currentAge + monthsSaveMore / 12 },
                    spendLess: { months: monthsSpendLess, age: currentAge + monthsSpendLess / 12, fireNumber: fireNumberSpendLess },
                    both: { months: monthsBoth, age: currentAge + monthsBoth / 12 }
                }
            };
        }

        function calculateMonthsToTarget(current, target, monthlyContrib, annualReturn) {
            if (current >= target) return 0;
            const monthlyReturn = annualReturn / 12;
            let wealth = current;
            let months = 0;
            const maxMonths = 600; // 50 years cap

            while (wealth < target && months < maxMonths) {
                wealth = (wealth + monthlyContrib) * (1 + monthlyReturn);
                months++;
            }
            return months;
        }

        function displayFireResults(result) {
            lastFireResult = result; // Store for export
            document.getElementById('fireResults').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');

            // FIRE Number
            document.getElementById('fireNumber').textContent = '$' + result.fireNumber.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('fireExpensesSummary').textContent = '$' + result.annualExpenses.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('fireSWRSummary').textContent = result.swr + '%';
            document.getElementById('fireRetirementYearsSummary').textContent = result.retirementYears;

            // Investment assumptions
            document.getElementById('fireRiskProfile').textContent = result.riskProfile.replace('_', ' ');
            document.getElementById('fireNominalReturn').textContent = (result.nominalReturn * 100).toFixed(0) + '%';
            document.getElementById('fireInflationUsed').textContent = result.inflation + '%';
            document.getElementById('fireRealReturn').textContent = (result.realReturn * 100).toFixed(1) + '%';

            // Educational section
            document.getElementById('eduExpenses').textContent = result.annualExpenses.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('eduSWR').textContent = result.swr + '%';
            document.getElementById('eduSWR2').textContent = result.swr + '%';
            document.getElementById('eduFireNum').textContent = result.fireNumber.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('eduAnnualWithdraw').textContent = result.annualExpenses.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('eduRetYears').textContent = result.retirementYears;

            // Adjust success rate and buffer based on retirement duration
            let successRate, bufferPct;
            if (result.retirementYears <= 30) {
                successRate = '95%+';
                bufferPct = '10-20%';
            } else if (result.retirementYears <= 40) {
                successRate = '90%+';
                bufferPct = '20-25%';
            } else {
                successRate = '85%+';
                bufferPct = '25-30%';
            }
            document.getElementById('eduSuccessRate').textContent = successRate;
            document.getElementById('eduBufferPct').textContent = bufferPct;

            // Progress
            const progressCapped = Math.min(result.progress, 100);
            document.getElementById('fireProgress').textContent = result.progress.toFixed(1) + '%';
            document.getElementById('fireProgressBar').style.width = progressCapped + '%';

            // FIRE Date
            if (result.monthsToFIRE >= 600) {
                document.getElementById('fireDate').textContent = '50+ years';
                document.getElementById('fireDateDetails').textContent = 'Consider increasing savings or reducing expenses';
            } else if (result.monthsToFIRE === 0) {
                document.getElementById('fireDate').textContent = 'üéâ Already FIRE!';
                document.getElementById('fireDateDetails').textContent = 'You\'ve reached financial independence';
            } else {
                document.getElementById('fireDate').textContent = 'Age ' + Math.round(result.fireAge);
                const yearsAway = Math.ceil(result.monthsToFIRE / 12);
                document.getElementById('fireDateDetails').textContent = yearsAway + ' years from now (' + result.fireYear + ')';
            }

            // Scenarios
            const baseYears = result.monthsToFIRE / 12;
            const saveMoreYears = result.scenarios.saveMore.months / 12;
            const spendLessYears = result.scenarios.spendLess.months / 12;
            const bothYears = result.scenarios.both.months / 12;

            document.getElementById('scenarioSaveMore').textContent = 'Age ' + Math.round(result.scenarios.saveMore.age);
            document.getElementById('scenarioSaveMoreDiff').textContent = Math.round(baseYears - saveMoreYears) + ' years earlier';

            document.getElementById('scenarioSpendLess').textContent = 'Age ' + Math.round(result.scenarios.spendLess.age);
            document.getElementById('scenarioSpendLessDiff').textContent = Math.round(baseYears - spendLessYears) + ' years earlier';

            document.getElementById('scenarioBoth').textContent = 'Age ' + Math.round(result.scenarios.both.age);
            document.getElementById('scenarioBothDiff').textContent = Math.round(baseYears - bothYears) + ' years earlier';

            // Chart
            updateFireChart(result);

            document.getElementById('fireResults').scrollIntoView({ behavior: 'smooth' });
        }

        function updateFireChart(result) {
            const ctx = document.getElementById('fireChart').getContext('2d');
            if (fireChart) fireChart.destroy();

            const years = Math.min(Math.ceil(result.monthsToFIRE / 12) + 5, 50);
            const labels = Array.from({length: years + 1}, (_, i) => 'Age ' + Math.round(result.currentAge + i));

            // Generate projection curves
            const generatePath = (monthlyContrib, targetFire) => {
                const monthlyReturn = result.realReturn / 12;
                let wealth = result.currentWealth;
                const path = [wealth];
                for (let year = 1; year <= years; year++) {
                    for (let month = 0; month < 12; month++) {
                        wealth = (wealth + monthlyContrib) * (1 + monthlyReturn);
                    }
                    path.push(wealth);
                }
                return path;
            };

            const basePath = generatePath(result.monthlyInvestment, result.fireNumber);
            const saveMorePath = generatePath(result.monthlyInvestment * 1.25, result.fireNumber);
            const spendLessPath = generatePath(result.monthlyInvestment, result.scenarios.spendLess.fireNumber);

            fireChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Current Path',
                            data: basePath,
                            borderColor: 'rgba(251, 146, 60, 1)',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: 'Save 25% More',
                            data: saveMorePath,
                            borderColor: 'rgba(34, 197, 94, 0.7)',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: 'FIRE Target',
                            data: labels.map(() => result.fireNumber),
                            borderColor: 'rgba(239, 68, 68, 0.8)',
                            borderDash: [10, 5],
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Lean FIRE (25% less)',
                            data: labels.map(() => result.scenarios.spendLess.fireNumber),
                            borderColor: 'rgba(59, 130, 246, 0.6)',
                            borderDash: [3, 3],
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#9ca3af' } }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#9ca3af', maxTicksLimit: 10 },
                            grid: { color: 'rgba(75, 85, 99, 0.3)' }
                        },
                        y: {
                            ticks: {
                                color: '#9ca3af',
                                callback: (value) => '$' + (value / 1000000).toFixed(1) + 'M'
                            },
                            grid: { color: 'rgba(75, 85, 99, 0.3)' }
                        }
                    }
                }
            });
        }

        function updateDirectContribution() {
            const base = parseFloat(document.getElementById('monthlyContributionBase')?.value) || 0;
            const topUp = parseFloat(document.getElementById('monthlyTopUp')?.value) || 0;
            const total = base + topUp;

            // Update display
            const totalDisplay = document.getElementById('directTotalSavings');
            if (totalDisplay) {
                totalDisplay.textContent = '$' + total.toLocaleString(undefined, {maximumFractionDigits: 0}) + '/mo';
            }

            // Update hidden field for form submission
            document.getElementById('monthlyContribution').value = total;
        }

        function updateCalculatedContribution() {
            const salary = parseFloat(document.getElementById('netMonthlySalary').value) || 0;
            const rate = parseFloat(document.getElementById('savingsRateSlider').value) || 0;
            const additionalSavings = parseFloat(document.getElementById('additionalSavings')?.value) || 0;
            const salaryContribution = salary * (rate / 100);
            const totalContribution = salaryContribution + additionalSavings;

            document.getElementById('savingsRateDisplay').textContent = rate + '%';
            document.getElementById('calculatedContribution').textContent = '$' + salaryContribution.toLocaleString(undefined, {maximumFractionDigits: 0}) + '/mo';

            // Update total display
            const totalDisplay = document.getElementById('totalMonthlySavings');
            if (totalDisplay) {
                totalDisplay.textContent = '$' + totalContribution.toLocaleString(undefined, {maximumFractionDigits: 0}) + '/mo';
            }

            // Update the hidden direct input so form submission works
            document.getElementById('monthlyContribution').value = totalContribution;

            // Also update the income field for sustainability checks
            document.getElementById('monthlyIncome').value = salary;

            // Provide feedback on savings rate
            const feedback = document.getElementById('savingsRateFeedback');
            if (rate === 0 && additionalSavings === 0) {
                feedback.textContent = '‚ö†Ô∏è Zero savings - relying entirely on current wealth growth';
                feedback.className = 'text-xs text-red-400';
            } else if (rate < 10 && additionalSavings === 0) {
                feedback.textContent = 'Below typical recommendation (10-15%). Consider increasing if possible.';
                feedback.className = 'text-xs text-yellow-400';
            } else if (rate <= 20) {
                feedback.textContent = '‚úì Solid savings rate. This is in the recommended range.';
                feedback.className = 'text-xs text-green-400';
            } else if (rate <= 35) {
                feedback.textContent = 'üí™ Above average! Make sure this is sustainable long-term.';
                feedback.className = 'text-xs text-blue-400';
            } else {
                feedback.textContent = 'üî• Very aggressive. Ensure you\'re not sacrificing quality of life.';
                feedback.className = 'text-xs text-yellow-400';
            }
        }

        document.getElementById('calculatorForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = document.getElementById('analyzeBtn');
            const btnText = document.getElementById('btnText');
            const spinner = document.getElementById('spinner');

            // Show loading state
            btn.disabled = true;
            spinner.classList.remove('hidden');

            if (calculatorMode === 'fire') {
                btnText.textContent = 'Calculating...';
                try {
                    const result = calculateFIRE();
                    displayFireResults(result);
                } catch (error) {
                    alert('Error calculating FIRE: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btnText.textContent = 'Calculate FIRE Date';
                    spinner.classList.add('hidden');
                }
                return;
            }

            // Goal Mode
            btnText.textContent = 'Analyzing...';

            // Get the nominal (future value) target - this is what they actually need
            const nominalTarget = getNominalTarget();
            const userEnteredTarget = parseFloat(document.getElementById('targetWealth').value);
            const targetType = document.getElementById('targetValueType').value;

            const data = {
                currentWealth: parseFloat(document.getElementById('currentWealth').value),
                targetWealth: nominalTarget, // Use inflation-adjusted target for calculations
                targetWealthUserEntered: userEnteredTarget, // Store original for display
                targetValueType: targetType,
                yearsToGoal: parseInt(document.getElementById('yearsToGoal').value),
                monthlyContribution: parseFloat(document.getElementById('monthlyContribution').value),
                riskProfile: document.querySelector('input[name="riskProfile"]:checked').value,
                inflationRate: parseFloat(document.getElementById('goalInflation').value) / 100,
            };

            const monthlyIncome = document.getElementById('monthlyIncome').value;
            if (monthlyIncome) {
                data.monthlyIncome = parseFloat(monthlyIncome);
            }

            try {
                // Try API first, fall back to local calculation
                let result;
                try {
                    const response = await fetch(`${API_URL}/api/analyze`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) throw new Error('API error');
                    result = await response.json();
                } catch (apiError) {
                    // Fall back to client-side calculation
                    result = calculateLocally(data);
                }

                displayResults(result);
            } catch (error) {
                alert('Error analyzing goal: ' + error.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Analyze My Goal';
                spinner.classList.add('hidden');
            }
        });

        function displayResults(result) {
            lastGoalResult = result; // Store for export
            document.getElementById('results').classList.remove('hidden');

            // Status banner
            const banner = document.getElementById('statusBanner');
            const statusEmoji = document.getElementById('statusEmoji');
            const statusText = document.getElementById('statusText');
            const probText = document.getElementById('probText');

            banner.className = 'rounded-lg p-4 flex items-center justify-between ';
            if (result.status === 'GREEN') {
                banner.classList.add('status-green');
                statusEmoji.textContent = 'üü¢';
                statusText.textContent = 'On Track';
            } else if (result.status === 'YELLOW') {
                banner.classList.add('status-yellow');
                statusEmoji.textContent = 'üü°';
                statusText.textContent = 'Needs Attention';
            } else {
                banner.classList.add('status-red');
                statusEmoji.textContent = 'üî¥';
                statusText.textContent = 'Critical';
            }
            probText.textContent = `${(result.probabilityOfSuccess * 100).toFixed(1)}% probability of success`;

            // Key metrics
            document.getElementById('requiredMonthly').textContent = 
                '$' + result.requiredMonthlyFor80Percent.toLocaleString(undefined, {maximumFractionDigits: 0});
            
            const gap = result.contributionGap;
            const gapEl = document.getElementById('contributionGap');
            if (gap > 0) {
                gapEl.textContent = `+$${gap.toLocaleString(undefined, {maximumFractionDigits: 0})}/mo needed`;
                gapEl.className = 'text-sm mt-1 text-red-400';
            } else {
                gapEl.textContent = `$${Math.abs(gap).toLocaleString(undefined, {maximumFractionDigits: 0})}/mo above minimum`;
                gapEl.className = 'text-sm mt-1 text-green-400';
            }

            document.getElementById('percentile20').textContent =
                '$' + result.projections.percentile20.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('percentile50').textContent =
                '$' + result.projections.percentile50.toLocaleString(undefined, {maximumFractionDigits: 0});

            // Sustainable income from target wealth
            const sustainableConservative = result.sustainableIncome?.conservative || (result.input.targetWealth * 0.03);
            const sustainableModerate = result.sustainableIncome?.moderate || (result.input.targetWealth * 0.04);
            document.getElementById('sustainableConservative').textContent =
                '$' + sustainableConservative.toLocaleString(undefined, {maximumFractionDigits: 0}) + '/yr';
            document.getElementById('sustainableModerate').textContent =
                '$' + sustainableModerate.toLocaleString(undefined, {maximumFractionDigits: 0}) + '/yr';

            // Flags
            const flagsContainer = document.getElementById('flagsContainer');
            const flagsList = document.getElementById('flagsList');
            flagsList.innerHTML = '';
            if (result.flags && result.flags.length > 0) {
                flagsContainer.classList.remove('hidden');
                result.flags.forEach(flag => {
                    const li = document.createElement('li');
                    li.textContent = '‚Ä¢ ' + flag;
                    flagsList.appendChild(li);
                });
            } else {
                flagsContainer.classList.add('hidden');
            }

            // Recommendations
            const recsList = document.getElementById('recommendationsList');
            recsList.innerHTML = '';
            result.recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.textContent = '‚Ä¢ ' + rec;
                recsList.appendChild(li);
            });

            // Chart
            updateChart(result);

            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function updateChart(result) {
            const ctx = document.getElementById('projectionChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }

            const years = result.input.yearsToGoal;
            const labels = Array.from({length: years + 1}, (_, i) => `Year ${i}`);
            
            // Simplified projection curves (exponential interpolation)
            const initial = result.input.currentWealth;
            const monthly = result.input.monthlyContribution;
            const p20Final = result.projections.percentile20;
            const p50Final = result.projections.percentile50;
            const p80Final = result.projections.percentile80;
            const target = result.input.targetWealth;

            // Generate curves
            const generateCurve = (finalValue) => {
                return labels.map((_, i) => {
                    const t = i / years;
                    // Approximate with contributions considered
                    const lumpGrowth = initial * Math.pow(finalValue / (initial + monthly * years * 12), t);
                    const contribGrowth = monthly * 12 * i * Math.pow(1 + (finalValue / (initial + monthly * years * 12) - 1), t/2);
                    return Math.round(lumpGrowth + contribGrowth);
                });
            };

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '80th Percentile',
                            data: generateCurve(p80Final),
                            borderColor: 'rgba(34, 197, 94, 0.5)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: '+1',
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: 'Median',
                            data: generateCurve(p50Final),
                            borderColor: 'rgba(59, 130, 246, 1)',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: '20th Percentile',
                            data: generateCurve(p20Final),
                            borderColor: 'rgba(239, 68, 68, 0.5)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: '-1',
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: 'Target',
                            data: labels.map(() => target),
                            borderColor: 'rgba(251, 191, 36, 0.8)',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#9ca3af' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { color: 'rgba(75, 85, 99, 0.3)' }
                        },
                        y: {
                            ticks: {
                                color: '#9ca3af',
                                callback: (value) => '$' + (value / 1000).toFixed(0) + 'K'
                            },
                            grid: { color: 'rgba(75, 85, 99, 0.3)' }
                        }
                    }
                }
            });
        }

        // Simple client-side fallback calculation
        function calculateLocally(data) {
            const profiles = {
                conservative: { ret: 0.06, vol: 0.10 },
                moderate: { ret: 0.08, vol: 0.13 },
                aggressive: { ret: 0.10, vol: 0.16 },
                very_aggressive: { ret: 0.12, vol: 0.20 },
                rentech: { ret: 0.40, vol: 0.20 }
            };

            const profile = profiles[data.riskProfile];
            const geoReturn = profile.ret - (profile.vol ** 2) / 2;
            const years = data.yearsToGoal;

            // Simplified deterministic projection
            const totalContribs = data.monthlyContribution * 12 * years;
            const fvLump = data.currentWealth * Math.pow(1 + geoReturn, years);
            const fvContribs = data.monthlyContribution * 12 * 
                ((Math.pow(1 + geoReturn, years) - 1) / geoReturn);
            
            const median = fvLump + fvContribs;
            const p20 = median * 0.6;  // Rough approximation
            const p80 = median * 1.5;

            const requiredCagr = Math.pow(data.targetWealth / data.currentWealth, 1/years) - 1;

            // Calculate probability based on where target falls in distribution
            // Using log-normal approximation: if target <= p20, prob > 80%; if target <= median, prob > 50%
            let probSuccess;
            if (data.targetWealth <= data.currentWealth) {
                // Already achieved goal - near certain success
                probSuccess = 0.99;
            } else if (data.targetWealth <= p20) {
                // Target below 20th percentile - very likely to succeed
                probSuccess = 0.85 + 0.10 * (p20 - data.targetWealth) / (p20 - data.currentWealth);
            } else if (data.targetWealth <= median) {
                // Target between p20 and median - likely to succeed
                probSuccess = 0.50 + 0.30 * (median - data.targetWealth) / (median - p20);
            } else if (data.targetWealth <= p80) {
                // Target between median and p80 - moderate chance
                probSuccess = 0.20 + 0.30 * (p80 - data.targetWealth) / (p80 - median);
            } else {
                // Target above p80 - unlikely
                probSuccess = Math.max(0.05, 0.20 * (p80 / data.targetWealth));
            }

            // Find required monthly (simplified)
            const targetGrowth = data.targetWealth / data.currentWealth;
            const lumpGrowth = Math.pow(1 + geoReturn, years);
            const deficit = data.targetWealth - (data.currentWealth * lumpGrowth);
            const contribGrowthFactor = ((Math.pow(1 + geoReturn, years) - 1) / geoReturn);
            const requiredMonthly = Math.max(0, (deficit / contribGrowthFactor) / 12 * 1.3);

            let status = 'GREEN';
            let flags = [];
            let recommendations = [];

            if (probSuccess < 0.5) {
                status = 'RED';
                flags.push('Goal may be unrealistic with current parameters');
                recommendations.push('Consider increasing contributions or extending timeline');
            } else if (probSuccess < 0.8) {
                status = 'YELLOW';
                flags.push('Success probability below 80% threshold');
                recommendations.push('Review risk profile or increase savings rate');
            } else {
                recommendations.push('Current plan is on track');
            }

            return {
                input: data,
                assumptions: {
                    arithmeticReturn: profile.ret,
                    geometricReturn: geoReturn,
                    volatility: profile.vol,
                    riskProfile: data.riskProfile
                },
                probabilityOfSuccess: probSuccess,
                requiredMonthlyFor80Percent: requiredMonthly,
                contributionGap: requiredMonthly - data.monthlyContribution,
                projections: {
                    percentile20: p20,
                    percentile50: median,
                    percentile80: p80
                },
                sustainableIncome: {
                    conservative: data.targetWealth * 0.03,
                    moderate: data.targetWealth * 0.04
                },
                status,
                flags,
                recommendations
            };
        }

        // Initialize displays on page load
        (function init() {
            updateInflationAdjustedTarget();
            setTargetType('today'); // Default to "today's buying power"
            updateDirectContribution(); // Initialize savings total
        })();
    </script>
</body>
</html>
